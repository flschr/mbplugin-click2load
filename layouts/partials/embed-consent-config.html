{{- /*
    Embed Consent Plugin Configuration Partial

    Include this in your <head> section to configure the plugin via data attributes.
    The JavaScript will automatically read these configuration values.

    Usage in baseof.html:
    {{ partial "embed-consent-config.html" . }}
*/ -}}

{{- $config := .Site.Params.embedConsent | default dict -}}
{{- $enableLocalStorage := $config.enableLocalStorage | default true -}}
{{- $showAlwaysAllowOption := $config.showAlwaysAllowOption | default true -}}
{{- $language := $config.language -}}
{{- $privacyPolicyUrl := $config.privacyPolicyUrl | default "" -}}

{{- /* Set data attributes on html element for JavaScript to read */ -}}
<script>
(function() {
    var root = document.documentElement;
    // Use dataset API (modern approach)
    root.dataset.embedConsentStorage = '{{ $enableLocalStorage }}';
    root.dataset.embedConsentAlwaysAllow = '{{ $showAlwaysAllowOption }}';
    {{- if $language -}}
    root.dataset.embedConsentLanguage = '{{ $language }}';
    {{- end -}}
    {{- if $privacyPolicyUrl -}}
    root.dataset.embedConsentPrivacyUrl = '{{ $privacyPolicyUrl }}';
    {{- end -}}
})();
</script>

{{- /*
    CRITICAL: Prevent iframes from loading BEFORE consent
    This script runs synchronously in <head> to intercept iframes
    BEFORE the browser starts loading their src attributes
*/ -}}
<script>
(function() {
    'use strict';

    // Store observer reference for cleanup
    var earlyBlockerObserver = null;

    // Function to block iframe from loading
    function blockIframe(iframe) {
        // Skip if already wrapped by main plugin
        if (iframe.closest('.embed-consent-wrapper')) {
            return;
        }

        // Skip if marked as no-consent
        if (iframe.matches('.no-consent, [data-no-consent]')) {
            return;
        }

        var src = iframe.getAttribute('src');
        if (src) {
            // Move src to data-consent-src to prevent loading
            iframe.dataset.consentSrc = src;
            iframe.removeAttribute('src');
            // Don't set consentProcessed here - let the main plugin handle that
        }
    }

    // Block any existing iframes (shouldn't be any in HEAD, but just in case)
    var existingIframes = document.querySelectorAll('iframe');
    for (var i = 0; i < existingIframes.length; i++) {
        blockIframe(existingIframes[i]);
    }

    // Set up MutationObserver to catch iframes as they're added to the DOM
    // This observer ONLY blocks - it doesn't wrap. The main plugin handles wrapping.
    if (typeof MutationObserver !== 'undefined') {
        earlyBlockerObserver = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                // Only check added nodes - more efficient
                for (var i = 0; i < mutation.addedNodes.length; i++) {
                    var node = mutation.addedNodes[i];
                    if (node.nodeType === 1) { // Element node
                        // Check if the node itself is an iframe
                        if (node.tagName === 'IFRAME') {
                            blockIframe(node);
                        }
                        // Check if the node contains iframes
                        else if (node.querySelectorAll) {
                            var iframes = node.querySelectorAll('iframe');
                            for (var j = 0; j < iframes.length; j++) {
                                blockIframe(iframes[j]);
                            }
                        }
                    }
                }
            });
        });

        // Start observing - childList only (no attribute watching needed)
        if (document.documentElement) {
            earlyBlockerObserver.observe(document.documentElement, {
                childList: true,
                subtree: true
            });
        }

        // Process any iframes after DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            var allIframes = document.querySelectorAll('iframe');
            for (var i = 0; i < allIframes.length; i++) {
                blockIframe(allIframes[i]);
            }
        });
    }

    // Expose cleanup function
    window.__embedConsentCleanupEarlyBlocker = function() {
        if (earlyBlockerObserver) {
            earlyBlockerObserver.disconnect();
            earlyBlockerObserver = null;
        }
    };
})();
</script>
