{{- /*
    Embed Consent Early Blocker

    This script prevents iframes from loading before the user gives consent.
    Include this in your <head> section BEFORE any content loads.

    Usage in baseof.html or head.html:
    {{ partial "embed-consent-config.html" . }}

    No configuration needed - the plugin uses sensible defaults:
    - LocalStorage enabled (remembers user preferences)
    - "Always allow" checkbox shown
    - Auto language detection (de/en based on browser)
*/ -}}

{{- /*
    CRITICAL: Prevent iframes from loading BEFORE consent
    This script runs synchronously in <head> to intercept iframes
    BEFORE the browser starts loading their src attributes
*/ -}}
<script>
(function() {
    'use strict';

    // Store observer reference for cleanup
    var earlyBlockerObserver = null;

    // Function to block iframe from loading
    function blockIframe(iframe) {
        // Skip if already wrapped by main plugin
        if (iframe.closest('.embed-consent-wrapper')) {
            return;
        }

        // Skip if marked as no-consent
        if (iframe.matches('.no-consent, [data-no-consent]')) {
            return;
        }

        var src = iframe.getAttribute('src');
        if (src) {
            // Move src to data-consent-src to prevent loading
            iframe.dataset.consentSrc = src;
            iframe.removeAttribute('src');
            // Don't set consentProcessed here - let the main plugin handle that
        }
    }

    // Block any existing iframes (shouldn't be any in HEAD, but just in case)
    var existingIframes = document.querySelectorAll('iframe');
    for (var i = 0; i < existingIframes.length; i++) {
        blockIframe(existingIframes[i]);
    }

    // Set up MutationObserver to catch iframes as they're added to the DOM
    // This observer ONLY blocks - it doesn't wrap. The main plugin handles wrapping.
    if (typeof MutationObserver !== 'undefined') {
        earlyBlockerObserver = new MutationObserver(function(mutations) {
            for (var m = 0; m < mutations.length; m++) {
                var mutation = mutations[m];
                // Only check added nodes - more efficient
                for (var i = 0; i < mutation.addedNodes.length; i++) {
                    var node = mutation.addedNodes[i];
                    if (node.nodeType === 1) { // Element node
                        // Check if the node itself is an iframe
                        if (node.tagName === 'IFRAME') {
                            blockIframe(node);
                        }
                        // Check if the node contains iframes
                        else if (node.querySelectorAll) {
                            var iframes = node.querySelectorAll('iframe');
                            for (var j = 0; j < iframes.length; j++) {
                                blockIframe(iframes[j]);
                            }
                        }
                    }
                }
            }
        });

        // Start observing - childList only (no attribute watching needed)
        if (document.documentElement) {
            earlyBlockerObserver.observe(document.documentElement, {
                childList: true,
                subtree: true
            });
        }
    }

    // Expose cleanup function - called by main plugin when it initializes
    window.__embedConsentCleanupEarlyBlocker = function() {
        if (earlyBlockerObserver) {
            earlyBlockerObserver.disconnect();
            earlyBlockerObserver = null;
        }
    };
})();
</script>

{{- /*
    Fallback styling for iframes when JavaScript is disabled
    This ensures iframes are responsive and visually appealing even without the plugin
*/ -}}
<noscript>
    <style>
        /* Style iframes that aren't wrapped by the plugin (no-JS fallback) */
        iframe {
            display: block;
            width: 100%;
            max-width: 100%;
            border: 0;
            border-radius: var(--embed-consent-radius, 0.5rem);
            background-color: #f5f5f5;
            margin: 1rem 0;
        }

        /* Responsive aspect ratio for video embeds */
        @supports (aspect-ratio: 16 / 9) {
            iframe {
                aspect-ratio: 16 / 9;
                height: auto;
            }
        }

        /* Fallback for older browsers without aspect-ratio support */
        @supports not (aspect-ratio: 16 / 9) {
            iframe {
                min-height: 400px;
            }
        }

        /* Dark mode support */
        @media (prefers-color-scheme: dark) {
            iframe {
                background-color: #1a1a1a;
            }
        }

        /* Optional: Info message that JS is disabled */
        body::before {
            content: "ℹ️ JavaScript ist deaktiviert. Externe Inhalte werden direkt geladen.";
            display: block;
            padding: 0.75rem 1rem;
            margin: 1rem;
            background-color: #e3f2fd;
            color: #0d47a1;
            border-left: 4px solid #1976d2;
            border-radius: 0.25rem;
            font-size: 0.9rem;
            line-height: 1.5;
        }

        @media (prefers-color-scheme: dark) {
            body::before {
                background-color: #1a237e;
                color: #90caf9;
                border-left-color: #42a5f5;
            }
        }
    </style>
</noscript>
