{{- /*
    Embed Consent Early Blocker

    This script prevents iframes from loading before the user gives consent.
    Include this in your <head> section BEFORE any content loads.

    Usage in baseof.html or head.html:
    {{ partial "embed-consent-config.html" . }}

    No configuration needed - the plugin uses sensible defaults:
    - LocalStorage enabled (remembers user preferences)
    - "Always allow" checkbox shown
    - Auto language detection (de/en based on browser)
*/ -}}

{{- /*
    CRITICAL: Prevent iframes from loading BEFORE consent
    This script runs synchronously in <head> to intercept iframes
    BEFORE the browser starts loading their src attributes
*/ -}}
<script>
(function() {
    'use strict';

    // Store observer reference for cleanup
    var earlyBlockerObserver = null;

    // Function to block iframe from loading
    function blockIframe(iframe) {
        // Skip if already wrapped by main plugin
        if (iframe.closest('.embed-consent-wrapper')) {
            return;
        }

        // Skip if marked as no-consent
        if (iframe.matches('.no-consent, [data-no-consent]')) {
            return;
        }

        var src = iframe.getAttribute('src');
        if (src) {
            // Move src to data-consent-src to prevent loading
            iframe.dataset.consentSrc = src;
            iframe.removeAttribute('src');
            // Don't set consentProcessed here - let the main plugin handle that
        }
    }

    // Block any existing iframes (shouldn't be any in HEAD, but just in case)
    var existingIframes = document.querySelectorAll('iframe');
    for (var i = 0; i < existingIframes.length; i++) {
        blockIframe(existingIframes[i]);
    }

    // Set up MutationObserver to catch iframes as they're added to the DOM
    // This observer ONLY blocks - it doesn't wrap. The main plugin handles wrapping.
    if (typeof MutationObserver !== 'undefined') {
        earlyBlockerObserver = new MutationObserver(function(mutations) {
            for (var m = 0; m < mutations.length; m++) {
                var mutation = mutations[m];
                // Only check added nodes - more efficient
                for (var i = 0; i < mutation.addedNodes.length; i++) {
                    var node = mutation.addedNodes[i];
                    if (node.nodeType === 1) { // Element node
                        // Check if the node itself is an iframe
                        if (node.tagName === 'IFRAME') {
                            blockIframe(node);
                        }
                        // Check if the node contains iframes
                        else if (node.querySelectorAll) {
                            var iframes = node.querySelectorAll('iframe');
                            for (var j = 0; j < iframes.length; j++) {
                                blockIframe(iframes[j]);
                            }
                        }
                    }
                }
            }
        });

        // Start observing - childList only (no attribute watching needed)
        if (document.documentElement) {
            earlyBlockerObserver.observe(document.documentElement, {
                childList: true,
                subtree: true
            });
        }
    }

    // Expose cleanup function - called by main plugin when it initializes
    window.__embedConsentCleanupEarlyBlocker = function() {
        if (earlyBlockerObserver) {
            earlyBlockerObserver.disconnect();
            earlyBlockerObserver = null;
        }
    };
})();
</script>

{{- /*
    Fallback for iframes when JavaScript is disabled
    Since embedded services (YouTube, ARTE, Komoot, Maps, etc.) require JavaScript,
    we hide iframes and show an informative notice instead
*/ -}}
<noscript>
    <style>
        /* Hide iframes when JavaScript is disabled */
        iframe:not(.no-consent):not([data-no-consent]) {
            display: none !important;
        }

        /* Create a notice container for blocked iframes */
        iframe:not(.no-consent):not([data-no-consent]) + .embed-noscript-notice,
        body:has(iframe:not(.no-consent):not([data-no-consent])) {
            /* Allow notice to be positioned */
        }

        /* Notice styling - matches plugin overlay design */
        .embed-noscript-notice {
            display: block;
            background: rgba(0, 0, 0, 0.05);
            border: 2px dashed rgba(0, 0, 0, 0.2);
            border-radius: var(--embed-consent-radius, 0.5rem);
            padding: 2rem 1.5rem;
            margin: 1rem 0;
            text-align: center;
            color: inherit;
        }

        .embed-noscript-notice::before {
            content: '‚ö†Ô∏è';
            display: block;
            font-size: 2.5rem;
            margin-bottom: 1rem;
            opacity: 0.7;
        }

        /* Language-specific messages using CSS */
        .embed-noscript-notice p {
            margin: 0;
            line-height: 1.6;
            opacity: 0.8;
        }

        /* Responsive adjustments */
        @media (max-width: 640px) {
            .embed-noscript-notice {
                padding: 1.5rem 1rem;
                margin: 0.75rem 0;
            }
        }

        /* Dark mode support */
        @media (prefers-color-scheme: dark) {
            .embed-noscript-notice {
                background: rgba(255, 255, 255, 0.05);
                border-color: rgba(255, 255, 255, 0.2);
            }
        }
    </style>

    {{- /* Insert notice elements after iframes using JavaScript fallback in noscript */ -}}
    <script>
        // This won't run, but serves as documentation
        // Actual implementation requires server-side rendering or manual insertion
    </script>
</noscript>

{{- /*
    Alternative: Hide ALL iframes globally when JS is disabled
    This is simpler and more reliable than trying to insert notices

    NOTE: iframes don't support ::before/::after pseudo-elements!
    We use a wrapper-based approach instead.
*/ -}}
<style id="embed-consent-noscript-fallback">
    /* Show iframes as clickable placeholder boxes when JavaScript is disabled */
    iframe:not(.no-consent):not([data-no-consent]) {
        display: flex !important;
        align-items: center;
        justify-content: center;
        min-height: 300px;
        width: 100%;
        background: rgba(0, 0, 0, 0.05);
        border: 2px dashed rgba(0, 0, 0, 0.2);
        border-radius: 0.5rem;
        margin: 1rem 0;
        cursor: pointer;
        position: relative;
        /* When JS is disabled, iframe keeps its src and is clickable */
        /* Clicking opens the embed in the current context */

        /* Add text indicator via background SVG */
        background-image:
            linear-gradient(rgba(0, 0, 0, 0.05), rgba(0, 0, 0, 0.05)),
            url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 400 200"><rect width="400" height="200" fill="none"/><text x="200" y="80" text-anchor="middle" font-family="system-ui, -apple-system, sans-serif" font-size="24" fill="%23666" font-weight="600">üîó Eingebetteter Inhalt</text><text x="200" y="120" text-anchor="middle" font-family="system-ui, -apple-system, sans-serif" font-size="18" fill="%23888">Klicken zum √ñffnen</text></svg>');
        background-position: center;
        background-repeat: no-repeat;
        background-size: contain;
        opacity: 0.5;
    }

    /* Add a visual hint that the box is clickable */
    iframe:not(.no-consent):not([data-no-consent]):hover {
        background-color: rgba(0, 0, 0, 0.08);
        border-color: rgba(0, 0, 0, 0.3);
        opacity: 0.8;
    }

    /* Global notice at the top explaining the empty boxes */
    .embed-noscript-global-notice {
        display: block;
        background: rgba(0, 0, 0, 0.05);
        border: 2px dashed rgba(0, 0, 0, 0.2);
        border-radius: 0.5rem;
        padding: 2rem 1.5rem;
        margin: 2rem auto;
        max-width: 800px;
        text-align: center;
        color: inherit;
        font-size: 0.95rem;
        line-height: 1.6;
    }

    .embed-noscript-global-notice::before {
        content: '‚ö†Ô∏è';
        display: block;
        font-size: 2.5rem;
        margin-bottom: 1rem;
        opacity: 0.7;
    }

    @media (prefers-color-scheme: dark) {
        iframe:not(.no-consent):not([data-no-consent]) {
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(255, 255, 255, 0.2);
            /* Dark mode SVG with lighter text colors */
            background-image:
                linear-gradient(rgba(255, 255, 255, 0.05), rgba(255, 255, 255, 0.05)),
                url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 400 200"><rect width="400" height="200" fill="none"/><text x="200" y="80" text-anchor="middle" font-family="system-ui, -apple-system, sans-serif" font-size="24" fill="%23ccc" font-weight="600">üîó Eingebetteter Inhalt</text><text x="200" y="120" text-anchor="middle" font-family="system-ui, -apple-system, sans-serif" font-size="18" fill="%23aaa">Klicken zum √ñffnen</text></svg>');
        }

        .embed-noscript-global-notice {
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(255, 255, 255, 0.2);
        }

        iframe:not(.no-consent):not([data-no-consent]):hover {
            background-color: rgba(255, 255, 255, 0.08);
            border-color: rgba(255, 255, 255, 0.3);
        }
    }

    @media (max-width: 640px) {
        iframe:not(.no-consent):not([data-no-consent]) {
            min-height: 200px;
        }

        .embed-noscript-global-notice {
            padding: 1.5rem 1rem;
            font-size: 0.9rem;
        }
    }
</style>

{{- /*
    Global notice for when JavaScript is disabled
    This will be visible at the top of the page
*/ -}}
<noscript>
    <div class="embed-noscript-global-notice">
        <strong>JavaScript erforderlich</strong><br>
        Eingebettete Inhalte (YouTube, ARTE, Karten, etc.) ben√∂tigen JavaScript zum Laden.<br>
        <strong>Klicken Sie auf eine graue Box unten, um den Inhalt direkt zu √∂ffnen.</strong>
        <hr style="margin: 1rem 0; border: none; border-top: 1px solid rgba(0,0,0,0.1);">
        <strong>JavaScript Required</strong><br>
        Embedded content (YouTube, ARTE, Maps, etc.) requires JavaScript to load.<br>
        <strong>Click on a gray box below to open the content directly.</strong>
    </div>
</noscript>

<script>
    // Remove the noscript fallback styles immediately when JavaScript IS available
    // This ensures the styles only apply when JS is truly disabled
    (function() {
        var style = document.getElementById('embed-consent-noscript-fallback');
        if (style && style.parentNode) {
            style.parentNode.removeChild(style);
        }
    })();
</script>
