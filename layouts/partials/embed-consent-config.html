{{- /*
    Embed Consent Early Blocker

    This script prevents iframes from loading before the user gives consent.
    Include this in your <head> section BEFORE any content loads.

    Usage in baseof.html or head.html:
    {{ partial "embed-consent-config.html" . }}

    No configuration needed - the plugin uses sensible defaults:
    - LocalStorage enabled (remembers user preferences)
    - "Always allow" checkbox shown
    - Auto language detection (de/en based on browser)
*/ -}}

{{- /*
    CRITICAL: Prevent iframes from loading BEFORE consent
    This script runs synchronously in <head> to intercept iframes
    BEFORE the browser starts loading their src attributes
*/ -}}

{{- /* No-JS Fallback: Hide all iframes when JavaScript is disabled */ -}}
<noscript>
    <style>
        /* Hide all iframes when JS is disabled */
        iframe:not(.no-consent):not([data-no-consent]) {
            display: none !important;
        }
        /* Show a global notice at the top of the page */
        body::before {
            content: "⚠️  Eingebettete Inhalte (YouTube, Maps, etc.) können ohne JavaScript nicht angezeigt werden. / Embedded content cannot be displayed without JavaScript.";
            display: block;
            background-color: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 0.5rem;
            padding: 1rem 1.5rem;
            margin: 1rem auto;
            max-width: 800px;
            font-family: system-ui, -apple-system, sans-serif;
            font-size: 0.9rem;
            line-height: 1.6;
            color: #856404;
            text-align: center;
        }
        @media (prefers-color-scheme: dark) {
            body::before {
                background-color: #332701;
                border-color: #664d03;
                color: #ffecb5;
            }
        }
    </style>
</noscript>

<script>
(function() {
    'use strict';

    // Mark document as JS-enabled (for no-JS fallback CSS)
    document.documentElement.classList.add('js-enabled');

    // Store observer reference for cleanup
    var earlyBlockerObserver = null;

    // Get translations based on browser language
    function getNoScriptText() {
        var lang = (navigator.language || navigator.userLanguage || '').toLowerCase().substring(0, 2);
        if (lang === 'de') {
            return {
                text: 'Dieser eingebettete Inhalt kann ohne JavaScript nicht angezeigt werden.',
                linkText: 'Inhalt direkt aufrufen'
            };
        }
        return {
            text: 'This embedded content cannot be displayed without JavaScript.',
            linkText: 'Open content directly'
        };
    }

    // Function to block iframe from loading
    function blockIframe(iframe) {
        // Skip if already wrapped by main plugin or early blocker
        if (iframe.closest('.embed-consent-wrapper') || iframe.closest('.embed-consent-nojs-wrapper')) {
            return;
        }

        // Skip if marked as no-consent
        if (iframe.matches('.no-consent, [data-no-consent]')) {
            return;
        }

        var src = iframe.getAttribute('src');
        if (src) {
            // Create wrapper for no-JS fallback
            var wrapper = document.createElement('div');
            wrapper.className = 'embed-consent-nojs-wrapper';

            // Create noscript element with fallback message
            var noscript = document.createElement('noscript');
            var translations = getNoScriptText();
            noscript.innerHTML = '<div class="embed-consent-noscript"><p>' +
                translations.text + '</p><p><a href="' + src + '" target="_blank" rel="noopener">' +
                translations.linkText + '</a></p></div>';

            // Insert wrapper before iframe
            iframe.parentNode.insertBefore(wrapper, iframe);

            // Move iframe into wrapper (after noscript)
            wrapper.appendChild(noscript);
            wrapper.appendChild(iframe);

            // Move src to data-consent-src to prevent loading
            iframe.dataset.consentSrc = src;
            iframe.removeAttribute('src');
            // Don't set consentProcessed here - let the main plugin handle that
        }
    }

    // Block any existing iframes (shouldn't be any in HEAD, but just in case)
    var existingIframes = document.querySelectorAll('iframe');
    for (var i = 0; i < existingIframes.length; i++) {
        blockIframe(existingIframes[i]);
    }

    // Set up MutationObserver to catch iframes as they're added to the DOM
    // This observer ONLY blocks - it doesn't wrap. The main plugin handles wrapping.
    if (typeof MutationObserver !== 'undefined') {
        earlyBlockerObserver = new MutationObserver(function(mutations) {
            for (var m = 0; m < mutations.length; m++) {
                var mutation = mutations[m];
                // Only check added nodes - more efficient
                for (var i = 0; i < mutation.addedNodes.length; i++) {
                    var node = mutation.addedNodes[i];
                    if (node.nodeType === 1) { // Element node
                        // Check if the node itself is an iframe
                        if (node.tagName === 'IFRAME') {
                            blockIframe(node);
                        }
                        // Check if the node contains iframes
                        else if (node.querySelectorAll) {
                            var iframes = node.querySelectorAll('iframe');
                            for (var j = 0; j < iframes.length; j++) {
                                blockIframe(iframes[j]);
                            }
                        }
                    }
                }
            }
        });

        // Start observing - childList only (no attribute watching needed)
        if (document.documentElement) {
            earlyBlockerObserver.observe(document.documentElement, {
                childList: true,
                subtree: true
            });
        }
    }

    // Expose cleanup function - called by main plugin when it initializes
    window.__embedConsentCleanupEarlyBlocker = function() {
        if (earlyBlockerObserver) {
            earlyBlockerObserver.disconnect();
            earlyBlockerObserver = null;
        }
    };
})();
</script>
