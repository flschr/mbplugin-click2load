{{- /*
    Embed Consent Early Blocker

    This script prevents iframes from loading before the user gives consent.
    Include this in your <head> section BEFORE any content loads.

    Usage in baseof.html or head.html:
    {{ partial "embed-consent-config.html" . }}

    No configuration needed - the plugin uses sensible defaults:
    - LocalStorage enabled (remembers user preferences)
    - "Always allow" checkbox shown
    - Auto language detection (de/en based on browser)
*/ -}}

{{- /*
    CRITICAL: Prevent iframes from loading BEFORE consent
    This script runs synchronously in <head> to intercept iframes
    BEFORE the browser starts loading their src attributes
*/ -}}
<script>
(function() {
    'use strict';

    // Store observer reference for cleanup
    var earlyBlockerObserver = null;

    // Function to block iframe from loading
    function blockIframe(iframe) {
        // Skip if already wrapped by main plugin
        if (iframe.closest('.embed-consent-wrapper')) {
            return;
        }

        // Skip if marked as no-consent
        if (iframe.matches('.no-consent, [data-no-consent]')) {
            return;
        }

        var src = iframe.getAttribute('src');
        if (src) {
            // Move src to data-consent-src to prevent loading
            iframe.dataset.consentSrc = src;
            iframe.removeAttribute('src');
            // Don't set consentProcessed here - let the main plugin handle that
        }
    }

    // Block any existing iframes (shouldn't be any in HEAD, but just in case)
    var existingIframes = document.querySelectorAll('iframe');
    for (var i = 0; i < existingIframes.length; i++) {
        blockIframe(existingIframes[i]);
    }

    // Set up MutationObserver to catch iframes as they're added to the DOM
    // This observer ONLY blocks - it doesn't wrap. The main plugin handles wrapping.
    if (typeof MutationObserver !== 'undefined') {
        earlyBlockerObserver = new MutationObserver(function(mutations) {
            for (var m = 0; m < mutations.length; m++) {
                var mutation = mutations[m];
                // Only check added nodes - more efficient
                for (var i = 0; i < mutation.addedNodes.length; i++) {
                    var node = mutation.addedNodes[i];
                    if (node.nodeType === 1) { // Element node
                        // Check if the node itself is an iframe
                        if (node.tagName === 'IFRAME') {
                            blockIframe(node);
                        }
                        // Check if the node contains iframes
                        else if (node.querySelectorAll) {
                            var iframes = node.querySelectorAll('iframe');
                            for (var j = 0; j < iframes.length; j++) {
                                blockIframe(iframes[j]);
                            }
                        }
                    }
                }
            }
        });

        // Start observing - childList only (no attribute watching needed)
        if (document.documentElement) {
            earlyBlockerObserver.observe(document.documentElement, {
                childList: true,
                subtree: true
            });
        }
    }

    // Expose cleanup function - called by main plugin when it initializes
    window.__embedConsentCleanupEarlyBlocker = function() {
        if (earlyBlockerObserver) {
            earlyBlockerObserver.disconnect();
            earlyBlockerObserver = null;
        }
    };
})();
</script>

{{- /*
    Fallback: Hide iframes when JavaScript is disabled
    This prevents embedded content from loading without consent

    Since YouTube, Vimeo, Maps, etc. require JavaScript anyway,
    hiding the iframes is the cleanest solution when JS is disabled.

    When JS IS enabled, this style block is immediately removed
    by the script below to prevent FOUC.
*/ -}}
<style id="embed-consent-noscript-fallback">
    /* Hide iframes when JavaScript is disabled */
    iframe:not(.no-consent):not([data-no-consent]) {
        display: none !important;
    }
</style>
<noscript>
    <style>
        /* Style iframes to show blocked state visually */
        iframe:not(.no-consent):not([data-no-consent]) {
            display: block !important;
            opacity: 0.15 !important;
            pointer-events: none !important;
            filter: grayscale(100%) blur(3px) !important;
            border: 3px dashed #ffc107 !important;
            background: #fff3cd !important;
            min-height: 200px !important;
            position: relative !important;
        }

        /* Create a wrapper effect around each iframe */
        iframe:not(.no-consent):not([data-no-consent])::before {
            content: '' !important;
            display: block !important;
            position: absolute !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            bottom: 0 !important;
            background: repeating-linear-gradient(
                45deg,
                rgba(255, 193, 7, 0.1),
                rgba(255, 193, 7, 0.1) 10px,
                rgba(255, 193, 7, 0.2) 10px,
                rgba(255, 193, 7, 0.2) 20px
            ) !important;
            z-index: 1 !important;
        }

        /* Container for iframe with local message */
        iframe:not(.no-consent):not([data-no-consent]) {
            box-sizing: border-box !important;
            margin: 1rem 0 !important;
        }

        /* Inject warning message after each iframe */
        iframe:not(.no-consent):not([data-no-consent]) + * {
            margin-top: 0 !important;
        }

        /* Add a visible warning box after each blocked iframe using adjacent sibling */
        iframe:not(.no-consent):not([data-no-consent]) ~ noscript {
            display: none !important;
        }

        /* Style for the inline warning that appears with each iframe */
        .embed-consent-noscript-inline {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 0.5rem;
            padding: 0.875rem 1rem;
            margin: -0.5rem 0 1.5rem 0;
            font-size: 0.8125rem;
            line-height: 1.5;
            color: #856404;
            font-family: system-ui, -apple-system, sans-serif;
            display: block;
        }

        .embed-consent-noscript-inline strong {
            display: block;
            font-size: 0.875rem;
            margin-bottom: 0.25rem;
            color: #664d03;
        }

        .embed-consent-noscript-inline a {
            color: #664d03;
            text-decoration: underline;
            font-weight: 500;
        }

        .embed-consent-noscript-inline a:hover {
            color: #523804;
        }

        @media (prefers-color-scheme: dark) {
            iframe:not(.no-consent):not([data-no-consent]) {
                background: #3d3500 !important;
                border-color: #ffc107 !important;
            }

            .embed-consent-noscript-inline {
                background: #3d3500;
                border-color: #ffc107;
                color: #ffc107;
            }

            .embed-consent-noscript-inline strong {
                color: #ffdb4d;
            }

            .embed-consent-noscript-inline a {
                color: #ffdb4d;
            }

            .embed-consent-noscript-inline a:hover {
                color: #fff;
            }
        }
    </style>
</noscript>
<script>
    // CRITICAL: Remove the noscript fallback styles IMMEDIATELY when JavaScript IS available
    // This must run synchronously right after the style tag to prevent FOUC (Flash of Unstyled Content)
    // and ensure iframes don't briefly show as dimmed boxes
    (function() {
        var style = document.getElementById('embed-consent-noscript-fallback');
        if (style && style.parentNode) {
            style.parentNode.removeChild(style);
        }
    })();
</script>
