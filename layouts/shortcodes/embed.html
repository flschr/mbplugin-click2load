{{- /*
    Hugo shortcode for consent-protected embeds

    Parameters:
    - provider: "youtube", "arte", "vimeo", "generic" (optional)
    - id: video ID for YouTube/Vimeo
    - url: full URL for ARTE or generic embeds
    - title: embed title (optional)
    - ratio: aspect ratio like "16/9" or "4/3" (default: "16/9")
    - thumbnail: URL to local preview image (optional)
    - consent_text: override consent text (optional)
    - button_label: override button text (optional)
    - always_allow_label: override checkbox text (optional)
*/ -}}

{{- /* Get site-wide configuration */ -}}
{{- $config := .Site.Params.embedConsent | default dict -}}
{{- $enableLocalStorage := $config.enableLocalStorage | default true -}}
{{- $showAlwaysAllowOption := $config.showAlwaysAllowOption | default true -}}
{{- $language := $config.language | default "en" -}}
{{- $privacyPolicyUrl := $config.privacyPolicyUrl | default "" -}}

{{- /* Get shortcode parameters */ -}}
{{- $provider := .Get "provider" | default "generic" -}}
{{- $id := .Get "id" | default "" -}}
{{- $url := .Get "url" | default "" -}}
{{- $title := .Get "title" | default "Embedded content" -}}
{{- $ratio := .Get "ratio" | default "16/9" -}}
{{- $thumbnail := .Get "thumbnail" | default "" -}}

{{- /* Custom text overrides */ -}}
{{- $customConsentText := .Get "consent_text" | default "" -}}
{{- $customButtonLabel := .Get "button_label" | default "" -}}
{{- $customAlwaysAllowLabel := .Get "always_allow_label" | default "" -}}

{{- /* Build iframe URL based on provider */ -}}
{{- $iframeUrl := "" -}}
{{- if eq $provider "youtube" -}}
    {{- if $id -}}
        {{- $iframeUrl = printf "https://www.youtube-nocookie.com/embed/%s" $id -}}
    {{- end -}}
{{- else if eq $provider "vimeo" -}}
    {{- if $id -}}
        {{- $iframeUrl = printf "https://player.vimeo.com/video/%s" $id -}}
    {{- end -}}
{{- else if or (eq $provider "arte") (eq $provider "generic") -}}
    {{- $iframeUrl = $url -}}
{{- end -}}

{{- /* Check if we have a valid URL */ -}}
{{- if not $iframeUrl -}}
    <div class="embed-consent-error" style="padding: 2rem; background: #fee; border: 2px solid #c33; border-radius: 0.5rem; color: #c33; text-align: center;">
        <strong>Embed Error:</strong> Missing required parameter.
        {{- if or (eq $provider "youtube") (eq $provider "vimeo") -}}
            Please provide an <code>id</code> parameter.
        {{- else -}}
            Please provide a <code>url</code> parameter.
        {{- end -}}
    </div>
{{- else -}}
    {{- /* Define translations */ -}}
    {{- $translations := dict
        "de" (dict
            "consentText" "Dieses eingebettete Medium wird von einem externen Anbieter bereitgestellt. Durch das Laden dieses Inhalts werden Daten an Dritte übertragen."
            "buttonLabel" "Inhalt laden"
            "alwaysAllowLabel" "Externe Medien auf dieser Website immer erlauben"
            "noScriptText" "Bitte aktivieren Sie JavaScript, um eingebettete Inhalte interaktiv zu laden."
            "providerYouTube" "YouTube"
            "providerVimeo" "Vimeo"
            "providerArte" "ARTE"
            "providerGeneric" "Externer Anbieter"
        )
        "en" (dict
            "consentText" "This embedded content is provided by an external service. By loading this content, data will be transmitted to third parties."
            "buttonLabel" "Load content"
            "alwaysAllowLabel" "Always allow external media on this site"
            "noScriptText" "Please enable JavaScript to load embedded content interactively."
            "providerYouTube" "YouTube"
            "providerVimeo" "Vimeo"
            "providerArte" "ARTE"
            "providerGeneric" "External Provider"
        )
    -}}

    {{- /* Get language-specific strings */ -}}
    {{- $langStrings := index $translations $language | default (index $translations "en") -}}
    {{- $consentText := $customConsentText | default $langStrings.consentText -}}
    {{- $buttonLabel := $customButtonLabel | default $langStrings.buttonLabel -}}
    {{- $alwaysAllowLabel := $customAlwaysAllowLabel | default $langStrings.alwaysAllowLabel -}}
    {{- $noScriptText := $langStrings.noScriptText -}}

    {{- /* Get provider display name */ -}}
    {{- $providerName := "" -}}
    {{- if eq $provider "youtube" -}}
        {{- $providerName = $langStrings.providerYouTube -}}
    {{- else if eq $provider "vimeo" -}}
        {{- $providerName = $langStrings.providerVimeo -}}
    {{- else if eq $provider "arte" -}}
        {{- $providerName = $langStrings.providerArte -}}
    {{- else -}}
        {{- $providerName = $langStrings.providerGeneric -}}
    {{- end -}}

    {{- /* Calculate padding-bottom for aspect ratio */ -}}
    {{- $paddingBottom := "56.25%" -}}
    {{- if eq $ratio "4/3" -}}
        {{- $paddingBottom = "75%" -}}
    {{- else if eq $ratio "1/1" -}}
        {{- $paddingBottom = "100%" -}}
    {{- else if eq $ratio "21/9" -}}
        {{- $paddingBottom = "42.857%" -}}
    {{- else -}}
        {{- /* Default 16/9 */ -}}
        {{- $paddingBottom = "56.25%" -}}
    {{- end -}}

    {{- /* Generate HTML output */ -}}
    <div class="embed-consent-wrapper"
         data-provider="{{ $provider }}"
         data-provider-name="{{ $providerName }}"
         data-language="{{ $language }}"
         data-enable-localstorage="{{ $enableLocalStorage }}"
         data-show-always-allow="{{ $showAlwaysAllowOption }}"
         data-privacy-url="{{ $privacyPolicyUrl }}"
         data-consent-text="{{ $consentText }}"
         data-button-label="{{ $buttonLabel }}"
         data-always-allow-label="{{ $alwaysAllowLabel }}"
         style="--aspect-ratio-padding: {{ $paddingBottom }};">

        {{- /* Consent overlay */ -}}
        <div class="embed-consent-overlay">
            {{- if $thumbnail -}}
                <div class="embed-consent-thumbnail" style="background-image: url('{{ $thumbnail }}');"></div>
            {{- end -}}

            <div class="embed-consent-content">
                <div class="embed-consent-icon">
                    {{- if eq $provider "youtube" -}}
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="48" height="48">
                            <path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/>
                        </svg>
                    {{- else if eq $provider "vimeo" -}}
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="48" height="48">
                            <path d="M23.977 6.416c-.105 2.338-1.739 5.543-4.894 9.609-3.268 4.247-6.026 6.37-8.29 6.37-1.409 0-2.578-1.294-3.553-3.881L5.322 11.4C4.603 8.816 3.834 7.522 3.01 7.522c-.179 0-.806.378-1.881 1.132L0 7.197a315.065 315.065 0 0 0 3.501-3.128C5.08 2.701 6.266 1.984 7.055 1.91c1.867-.18 3.016 1.1 3.447 3.838.465 2.953.789 4.789.971 5.507.539 2.45 1.131 3.674 1.776 3.674.502 0 1.256-.796 2.265-2.385 1.004-1.589 1.54-2.797 1.612-3.628.144-1.371-.395-2.061-1.614-2.061-.574 0-1.167.121-1.777.391 1.186-3.868 3.434-5.757 6.762-5.637 2.473.06 3.628 1.664 3.493 4.797l-.013.01z"/>
                        </svg>
                    {{- else -}}
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="48" height="48">
                            <rect x="2" y="2" width="20" height="20" rx="2.18" ry="2.18"></rect>
                            <line x1="7" y1="2" x2="7" y2="22"></line>
                            <line x1="17" y1="2" x2="17" y2="22"></line>
                            <line x1="2" y1="12" x2="22" y2="12"></line>
                            <line x1="2" y1="7" x2="7" y2="7"></line>
                            <line x1="2" y1="17" x2="7" y2="17"></line>
                            <line x1="17" y1="17" x2="22" y2="17"></line>
                            <line x1="17" y1="7" x2="22" y2="7"></line>
                        </svg>
                    {{- end -}}
                </div>

                <p class="embed-consent-text">
                    <strong>{{ $providerName }}</strong><br>
                    {{ $consentText }}
                    {{- if $privacyPolicyUrl -}}
                        <br><a href="{{ $privacyPolicyUrl }}" class="embed-consent-privacy-link">{{ if eq $language "de" }}Mehr erfahren{{ else }}Learn more{{ end }}</a>
                    {{- end -}}
                </p>

                <div class="embed-consent-actions">
                    {{- if and $enableLocalStorage $showAlwaysAllowOption -}}
                        <label class="embed-consent-checkbox">
                            <input type="checkbox" class="embed-consent-checkbox-input">
                            <span class="embed-consent-checkbox-label">{{ $alwaysAllowLabel }}</span>
                        </label>
                    {{- end -}}

                    <button type="button" class="embed-consent-button">
                        {{ $buttonLabel }}
                    </button>
                </div>
            </div>
        </div>

        {{- /* Iframe (initially without src) */ -}}
        <iframe class="embed-consent-iframe"
                data-src="{{ $iframeUrl }}"
                title="{{ $title }}"
                frameborder="0"
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                referrerpolicy="strict-origin-when-cross-origin"
                allowfullscreen
                loading="lazy"></iframe>

        {{- /* No-JavaScript fallback */ -}}
        <noscript>
            <div class="embed-consent-noscript">
                {{ $noScriptText }}
                <br>
                <a href="{{ $iframeUrl }}" target="_blank" rel="noopener noreferrer">{{ if eq $language "de" }}Inhalt in neuem Tab öffnen{{ else }}Open content in new tab{{ end }}</a>
            </div>
        </noscript>
    </div>
{{- end -}}
